# üé® Endpoint para Gera√ß√£o de HTML

## Vis√£o Geral

O endpoint `/generate_html` permite gerar HTML formatado de explica√ß√µes de previs√µes sem precisar armazenar o HTML no servi√ßo que consome a API. Isso proporciona maior flexibilidade e separa√ß√£o de responsabilidades. **NOVIDADE**: Agora suporta retorno direto de HTML (`text/html`) para exibi√ß√£o imediata no navegador.

## üîß Endpoint

```
POST /generate_html
```

## üìù Par√¢metros

### Obrigat√≥rios

```json
{
  "item_id": 1,
  "prediction": {
    "yhat": 150.5,
    "yhat_lower": 130.2,
    "yhat_upper": 170.8,
    "trend": 145.0,
    "yearly": 5.5,
    "ds": "2024-01-01"
  }
}
```

### Opcionais

```json
{
  "explanation_data": {
    "data_points": 12,
    "confidence_score": "Alta",
    "mape": 8.5,
    "r2": 0.85,
    "outlier_count": 1,
    "trend_slope": 2.5,
    "seasonal_pattern": {1: 1.1, 2: 0.9, 3: 1.0},
    "training_period": {
      "start": "2023-01-01",
      "end": "2023-12-01"
    }
  },
  "layout": "compact",
  "is_quarterly": false,
  "quarterly_info": {
    "quarter_name": "Q1/2024",
    "start_date": "2024-01-01",
    "end_date": "2024-03-01",
    "monthly_details": [...]
  }
}
```

## üì§ Resposta

```json
{
  "html": "<div style='...'>...</div>",
  "info": {
    "layout": "compact",
    "size_chars": 3616,
    "is_quarterly": false,
    "item_id": 1,
    "period": "Janeiro/2024"
  }
}
```

## üéØ Casos de Uso

### 1. Gera√ß√£o de Popup Compacto

```python
import requests

dados = {
    "item_id": 1,
    "prediction": {
        "yhat": 150.5,
        "yhat_lower": 130.2,
        "yhat_upper": 170.8,
        "trend": 145.0,
        "yearly": 5.5,
        "ds": "2024-01-01"
    },
    "explanation_data": {
        "confidence_score": "Alta",
        "mape": 8.5,
        "data_points": 12
    },
    "layout": "compact"
}

response = requests.post("http://localhost:5000/generate_html", json=dados)
html_popup = response.json()['html']

# Usar em popup/modal
```

### 2. Relat√≥rio Completo

```python
dados = {
    "item_id": 2,
    "prediction": {...},
    "explanation_data": {...},
    "layout": "full"  # Layout completo
}

response = requests.post("http://localhost:5000/generate_html", json=dados)
html_relatorio = response.json()['html']

# Usar em p√°gina de relat√≥rio
```

### 3. Previs√£o Trimestral

```python
dados = {
    "item_id": 3,
    "prediction": {...},
    "explanation_data": {...},
    "layout": "compact",
    "is_quarterly": True,
    "quarterly_info": {
        "quarter_name": "Q2/2024",
        "monthly_details": [
            {"month": "2024-04", "yhat": 120},
            {"month": "2024-05", "yhat": 135},
            {"month": "2024-06", "yhat": 145}
        ]
    }
}

response = requests.post("http://localhost:5000/generate_html", json=dados)
html_trimestre = response.json()['html']
```

## üìä Compara√ß√£o de Layouts

| Caracter√≠stica | Full | Compact |
|---|---|---|
| **Largura** | Responsivo (zoom 0.75) | 100% |
| **Tamanho t√≠pico** | ~6.800 chars | ~3.600 chars |
| **Se√ß√µes** | Todas completas | Essenciais |
| **Uso ideal** | Relat√≥rios | Popups |

## üîÑ Fluxo de Uso Recomendado

### Op√ß√£o 1: Campo _html_data (NOVO - RECOMENDADO)
```python
# 1. Fazer previs√£o (sempre retorna _html_data)
response = requests.post("/predict", json={...})
previsao = response.json()['forecast'][0]

# 2. Armazenar _html_data no banco
html_data_para_banco = previsao['_html_data']
# Salvar html_data_para_banco em campo JSON/TEXT do banco

# 3. Gerar HTML quando necess√°rio
html_response = requests.post("/generate_html", json={
    "html_data": html_data_do_banco,  # Recuperado do banco
    "layout": "compact"  # ou "full"
})
```

### Op√ß√£o 2: Par√¢metros Individuais
1. Fazer previs√£o com `include_explanation: false`
2. Armazenar dados da previs√£o individualmente
3. Gerar HTML passando par√¢metros separados via `/generate_html`

### Op√ß√£o 3: HTML Direto
1. Fazer previs√£o com `include_explanation: true`
2. Usar `html_summary` diretamente

## ‚öôÔ∏è Par√¢metros de explanation_data

```json
{
  "data_points": 12,           // N√∫mero de per√≠odos hist√≥ricos
  "confidence_score": "Alta",  // "Alta", "M√©dia", "Baixa"
  "mape": 8.5,                // Erro percentual m√©dio
  "r2": 0.85,                 // Coeficiente de determina√ß√£o
  "outlier_count": 1,         // Outliers removidos
  "trend_slope": 2.5,         // Inclina√ß√£o da tend√™ncia
  "seasonal_strength": 0.4,   // For√ßa da sazonalidade
  "trend_strength": 0.3,      // For√ßa da tend√™ncia
  "seasonal_pattern": {...},  // Padr√£o sazonal por m√™s
  "training_period": {        // Per√≠odo de treinamento
    "start": "2023-01-01",
    "end": "2023-12-01"
  }
}
```

## üö® C√≥digos de Erro

- **400**: Par√¢metros obrigat√≥rios ausentes
- **400**: Formato de data inv√°lido
- **500**: Erro interno na gera√ß√£o do HTML

## üß™ Teste

Execute o exemplo completo:

```bash
python exemplo_generate_html.py
```

## üì¶ Campo _html_data (NOVO)

O endpoint `/predict` agora **sempre retorna** um campo `_html_data` com todos os dados necess√°rios para gerar HTML posteriormente:

```json
{
  "forecast": [
    {
      "item_id": 1,
      "yhat": 150.5,
      "ds": "2024-01-01 00:00:00",
      "_html_data": {
        "item_id": 1,
        "prediction": {
          "yhat": 150.5,
          "yhat_lower": 130.2,
          "yhat_upper": 170.8,
          "trend": 145.0,
          "yearly": 5.5,
          "ds": "2024-01-01"
        },
        "explanation_data": {
          "data_points": 12,
          "confidence_score": "Alta",
          "mape": 8.5,
          "r2": 0.85,
          "trend_slope": 2.5,
          "seasonal_pattern": {...}
        },
        "is_quarterly": false,
        "date_iso": "2024-01-01T00:00:00",
        "timestamp": 1704067200.0
      }
    }
  ]
}
```

### üóÑÔ∏è Armazenamento no Banco

```sql
CREATE TABLE previsoes (
    id SERIAL PRIMARY KEY,
    item_id INTEGER,
    data_previsao DATE,
    yhat DECIMAL(10,2),
    html_data JSONB  -- Armazenar o campo _html_data aqui
);

INSERT INTO previsoes (item_id, data_previsao, yhat, html_data)
VALUES (1, '2024-01-01', 150.5, '{"item_id": 1, "prediction": {...}}');
```

### üé® Gera√ß√£o de HTML do Banco

```python
# Recuperar do banco
html_data_do_banco = row['html_data']  # JSON do banco

# Gerar HTML
response = requests.post("/generate_html", json={
    "html_data": html_data_do_banco,
    "layout": "compact"
})

popup_html = response.json()['html']
```

## üí° Vantagens

‚úÖ **Flexibilidade**: Gera HTML sob demanda  
‚úÖ **Performance**: N√£o armazena HTML desnecess√°rio  
‚úÖ **Separa√ß√£o**: L√≥gica de apresenta√ß√£o separada  
‚úÖ **Customiza√ß√£o**: Diferentes layouts conforme necessidade  
‚úÖ **Compatibilidade**: Funciona com dados existentes  
‚úÖ **Banco otimizado**: Armazena apenas dados estruturados  
‚úÖ **Regenera√ß√£o**: Permite gerar HTML quando necess√°rio 

## Funcionalidades

### ‚úÖ Recursos Dispon√≠veis

1. **Gera√ß√£o de HTML**: Converte dados de explica√ß√£o em HTML formatado
2. **Layouts Flex√≠veis**: Suporte para layouts `full` e `compact`
3. **Previs√µes Mensais e Trimestrais**: Funciona com ambos os tipos
4. **M√∫ltiplos Formatos de Entrada**: html_data ou par√¢metros individuais
5. **üÜï Retorno HTML Direto**: HTML puro (`text/html`) ou JSON (padr√£o)

### üéØ Modos de Retorno

| Modo | Content-Type | Uso Ideal |
|------|-------------|-----------|
| **JSON** (padr√£o) | `application/json` | APIs, processamento program√°tico |
| **üÜï HTML Direto** | `text/html` | Navegadores, iframes, downloads |

## M√©todos de Uso

### 1. üÜï HTML Direto com Par√¢metro

```python
payload = {
    "html_data": dados_do_banco,
    "layout": "compact",
    "return_html_direct": True  # üÜï Novo par√¢metro
}

response = requests.post("/generate_html", json=payload)
# response.text cont√©m HTML puro pronto para uso
```

### 2. üÜï HTML Direto com Header

```python
payload = {
    "html_data": dados_do_banco,
    "layout": "full"
}

response = requests.post(
    "/generate_html", 
    json=payload,
    headers={"Accept": "text/html"}  # üÜï Header especial
)
# response.text cont√©m HTML puro
```

### 3. JSON Tradicional (Padr√£o)

```python
payload = {
    "html_data": dados_do_banco,
    "layout": "compact"
}

response = requests.post("/generate_html", json=payload)
json_data = response.json()
html_content = json_data["html"]  # HTML dentro do JSON
```

## Formatos de Entrada

### Formato 1: html_data (Dados do Banco) - **RECOMENDADO**

```python
{
    "html_data": {
        "item_id": 1687,
        "prediction": {
            "ds": "2025-07-01 00:00:00",
            "yhat": 1227.22,
            "yhat_lower": 502.75,
            "yhat_upper": 1951.69,
            "trend": 1380.92,
            "yearly": -153.7
        },
        "explanation_data": {
            "confidence_score": "M√©dia",
            "data_points": 29,
            "mape": 23.16,
            "r2": 0.40,
            "seasonal_pattern": {...},
            "training_period": {...}
        },
        "is_quarterly": false,
        "date_iso": "2025-07-01T00:00:00",
        "timestamp": 1751328000
    },
    "layout": "compact",
    "return_html_direct": true  # üÜï Opcional
}
```

### Formato 2: Par√¢metros Individuais

```python
{
    "item_id": 1687,
    "prediction": {
        "ds": "2025-07-01 00:00:00",
        "yhat": 1227.22,
        "yhat_lower": 502.75,
        "yhat_upper": 1951.69,
        "trend": 1380.92,
        "yearly": -153.7
    },
    "explanation_data": {
        "confidence_score": "M√©dia",
        "data_points": 29,
        # ... outros campos
    },
    "layout": "full",
    "is_quarterly": false,
    "return_html_direct": true  # üÜï Opcional
}
```

## Layouts Dispon√≠veis

### Layout Full (Padr√£o)
- **Tamanho**: ~800px largura, ~6.800 caracteres
- **Uso**: P√°ginas completas, relat√≥rios detalhados
- **Conte√∫do**: Cabe√ßalho, detalhamento completo, gr√°ficos, recomenda√ß√µes

### Layout Compact
- **Tamanho**: ~400px largura, ~3.600 caracteres  
- **Uso**: Popups, modais, widgets
- **Conte√∫do**: Informa√ß√µes essenciais, design otimizado

## üÜï Casos de Uso do HTML Direto

### 1. üîó Link Direto para Relat√≥rio
```javascript
// Frontend: Abrir relat√≥rio em nova aba
window.open('/generate_html_url', '_blank');
```

### 2. üñºÔ∏è Iframe Incorporado
```html
<!-- Incorporar em modal ou popup -->
<iframe src="/api/generate_html" width="450" height="600"></iframe>
```

### 3. üíæ Download de Arquivo HTML
```python
response = requests.post("/generate_html", json=payload, headers={"Accept": "text/html"})
with open("relatorio.html", "w", encoding="utf-8") as f:
    f.write(response.text)
```

### 4. üì± WebView Mobile
```java
// Android
webView.loadData(htmlContent, "text/html", "UTF-8");
```

### 5. üìß Email HTML
```python
# Layout compact ideal para email
payload = {"html_data": dados, "layout": "compact", "return_html_direct": True}
html_email = requests.post("/generate_html", json=payload).text
send_email(to="user@email.com", html_body=html_email)
```

## Respostas

### üÜï Resposta HTML Direto
```
Status: 200 OK
Content-Type: text/html; charset=utf-8

<div style="font-family: Arial, sans-serif; ...">
    <!-- HTML formatado pronto para uso -->
</div>
```

### Resposta JSON (Padr√£o)
```json
{
    "html": "<div style=\"font-family: Arial...\">...</div>",
    "info": {
        "layout": "compact",
        "size_chars": 3640,
        "is_quarterly": false,
        "item_id": 1687,
        "period": "Julho/2025"
    }
}
```

## üîÑ Fluxo Completo Recomendado

### 1. Na Previs√£o (Armazenar no Banco)
```python
# Endpoint /predict retorna campo _html_data
response = requests.post("/predict", json={"sales_data": [...]})
forecast = response.json()["forecast"][0]
html_data = forecast["_html_data"]  # üóÉÔ∏è Salvar no banco
```

### 2. Na Exibi√ß√£o (Gerar HTML)
```python
# Usar dados do banco para gerar HTML
payload = {
    "html_data": html_data_do_banco,
    "layout": "compact",
    "return_html_direct": True  # üÜï HTML direto
}
html_response = requests.post("/generate_html", json=payload)
# html_response.text √© HTML puro pronto para uso
```

## Tratamento de Erros

### HTML Direto
```
Status: 400 Bad Request
Content-Type: text/html; charset=utf-8

<html>
<body>
    <h1>Erro: Campo obrigat√≥rio 'item_id' n√£o fornecido</h1>
</body>
</html>
```

### JSON (Padr√£o)
```json
{
    "error": "Campo obrigat√≥rio 'item_id' n√£o fornecido"
}
```

## Performance e Considera√ß√µes

### üìä Compara√ß√£o de Tamanhos
| Layout | Tamanho HTML | Uso de Banda | Tempo de Renderiza√ß√£o |
|--------|-------------|---------------|----------------------|
| Full | ~6.800 chars | Alto | Moderado |
| Compact | ~3.600 chars | Baixo | R√°pido |

### üéØ Recomenda√ß√µes
- **Popups/Modais**: Use `layout: "compact"`
- **P√°ginas Completas**: Use `layout: "full"`
- **Mobile**: Prefira `compact` por performance
- **Email**: Sempre `compact` + HTML direto
- **Relat√≥rios**: `full` para m√°ximo detalhamento

## Exemplo Completo

```python
import requests

# Dados do banco (campo _html_data)
html_data = {
    "item_id": 1687,
    "prediction": {
        "ds": "2025-07-01 00:00:00",
        "yhat": 1227.22,
        "yhat_lower": 502.75,
        "yhat_upper": 1951.69,
        "trend": 1380.92,
        "yearly": -153.7
    },
    "explanation_data": {
        "confidence_score": "M√©dia",
        "data_points": 29,
        "mape": 23.16,
        "r2": 0.40,
        "seasonal_pattern": {
            "1": 0.68, "2": 0.73, "3": 0.91, "4": 0.80,
            "5": 0.69, "6": 0.80, "7": 0.89, "8": 0.95,
            "9": 1.19, "10": 1.51, "11": 1.55, "12": 1.12
        },
        "seasonal_strength": 1.74,
        "std": 528.05,
        "training_period": {
            "start": "2023-01-31",
            "end": "2025-05-31",
            "months": 29
        },
        "trend_slope": 18.63,
        "trend_strength": 0.47
    },
    "is_quarterly": False,
    "date_iso": "2025-07-01T00:00:00",
    "timestamp": 1751328000
}

# Gerar HTML direto
response = requests.post(
    "http://localhost:5000/generate_html",
    json={
        "html_data": html_data,
        "layout": "compact",
        "return_html_direct": True
    }
)

if response.status_code == 200:
    # HTML pronto para uso
    html_content = response.text
    print(f"HTML gerado: {len(html_content)} caracteres")
    
    # Salvar como arquivo
    with open("explicacao.html", "w", encoding="utf-8") as f:
        f.write(html_content)
        
    print("‚úÖ HTML salvo em explicacao.html")
else:
    print(f"‚ùå Erro: {response.text}")
```

## üéâ Vantagens do HTML Direto

1. **üöÄ Performance**: Menos processamento no frontend
2. **üåê Compatibilidade**: Funciona em qualquer navegador
3. **üì± Versatilidade**: Ideal para WebViews, emails, PDFs
4. **‚ö° Simplicidade**: HTML pronto para uso, sem parsing
5. **üîó Integra√ß√£o**: Perfeito para iframes e incorpora√ß√µes
6. **üíæ Efici√™ncia**: Menos bytes transferidos que JSON

---

**Vers√£o**: 1.2.0 - Suporte a HTML Direto  
**Data**: Dezembro 2024 